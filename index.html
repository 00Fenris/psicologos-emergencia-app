<!DOCTYPE html>
<html lang="es">
<head>
    <script>
      // Configuración real de Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyA59Jl1NsshafjLVzuQswpc3-4BsGUgIBI",
        authDomain: "proyecto-psicologos-7f53f.firebaseapp.com",
        projectId: "proyecto-psicologos-7f53f",
        storageBucket: "proyecto-psicologos-7f53f.appspot.com",
        messagingSenderId: "1032754415458",
        appId: "1:1032754415458:web:e0975b2549ec1373584e3b",
        measurementId: "G-DBBG2CJFQ7"
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.firestore();
      // --- Lógica principal y vistas ---
      function mostrarVista(vista) {
        document.getElementById('login').classList.add('hidden');
        document.getElementById('acceso').classList.add('hidden');
        document.getElementById('vistaPsicologo').classList.add('hidden');
        document.getElementById('vistaCoordinador').classList.add('hidden');
        if (vista === 'psicologo') document.getElementById('vistaPsicologo').classList.remove('hidden');
        if (vista === 'coordinador') document.getElementById('vistaCoordinador').classList.remove('hidden');
        if (vista === 'login') document.getElementById('login').classList.remove('hidden');
      }
      // Login y registro
      document.getElementById('btnLogin').onclick = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
          const userCred = await auth.signInWithEmailAndPassword(email, pass);
          const user = userCred.user;
          // Obtén el rol del usuario
          const doc = await db.collection('usuarios').doc(user.uid).get();
          const rol = doc.exists ? doc.data().rol : 'psicologo';
          mostrarVista(rol);
        } catch (e) {
          document.getElementById('loginError').textContent = e.message;
        }
      };
      document.getElementById('btnRegister').onclick = async () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        const rol = document.getElementById('rol').value;
        try {
          const userCred = await auth.createUserWithEmailAndPassword(email, pass);
          const user = userCred.user;
          await db.collection('usuarios').doc(user.uid).set({ rol });
          mostrarVista('login');
          document.getElementById('loginError').textContent = 'Registro exitoso. Ahora puedes iniciar sesión.';
        } catch (e) {
          document.getElementById('loginError').textContent = e.message;
        }
      };
      // Cerrar sesión
      function logout() {
        auth.signOut();
        mostrarVista('login');
      }
      document.getElementById('btnSalirPsicologo').onclick = logout;
      document.getElementById('btnSalirCoordinador').onclick = logout;
      // Mostrar login al cargar
      mostrarVista('login');
      // Mantener sesión
      auth.onAuthStateChanged(async user => {
        if (user) {
          const doc = await db.collection('usuarios').doc(user.uid).get();
          const rol = doc.exists ? doc.data().rol : 'psicologo';
          mostrarVista(rol);
          document.getElementById('acceso').style.display = 'none';
        } else {
          mostrarVista('login');
          document.getElementById('acceso').style.display = '';
        }
      });

      // --- CHAT FIRESTORE ---
      function renderChat(container, mensajes, userType) {
        container.innerHTML = '';
        mensajes.forEach(msg => {
          const div = document.createElement('div');
          div.style.marginBottom = '8px';
          div.style.textAlign = msg.userType === userType ? 'right' : 'left';
          div.innerHTML = `<span style=\"background:${msg.userType === userType ? '#bee3f8' : '#fed7d7'};padding:6px 12px;border-radius:8px;display:inline-block;\">${msg.text}</span>`;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      }
      var chatPsico = document.getElementById('chatPsico');
      var chatCoord = document.getElementById('chatCoord');
      var btnSendPsico = document.getElementById('btnSendPsico');
      var btnSendCoord = document.getElementById('btnSendCoord');
      var msgPsico = document.getElementById('msgPsico');
      var msgCoord = document.getElementById('msgCoord');
      var selectPsico = document.getElementById('selectPsico');
      var currentPsicoId = '';
      function cargarPsicologos() {
        db.collection('usuarios').where('rol', '==', 'psicologo').get().then(snapshot => {
          selectPsico.innerHTML = '';
          snapshot.forEach(doc => {
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = doc.data().email || doc.id;
            selectPsico.appendChild(option);
          });
          if(selectPsico.options.length > 0) {
            currentPsicoId = selectPsico.value;
            listenChatCoord(currentPsicoId);
          }
        });
      }
      function listenChatCoord(psicoId) {
        db.collection('conversaciones').doc(psicoId + '_coordinador').collection('mensajes').orderBy('timestamp')
          .onSnapshot(snapshot => {
            const mensajes = snapshot.docs.map(doc => doc.data());
            renderChat(chatCoord, mensajes, 'coordinador');
          });
      }
      if(selectPsico) {
        selectPsico.onchange = () => {
          currentPsicoId = selectPsico.value;
          listenChatCoord(currentPsicoId);
        };
        cargarPsicologos();
      }
      if(btnSendCoord && msgCoord) {
        btnSendCoord.onclick = () => {
          const text = msgCoord.value.trim();
          if(!text || !currentPsicoId) return;
          db.collection('conversaciones').doc(currentPsicoId + '_coordinador').collection('mensajes').add({
            text,
            userType: 'coordinador',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          msgCoord.value = '';
        };
      }
      function listenChatPsico(userId) {
        db.collection('conversaciones').doc(userId + '_coordinador').collection('mensajes').orderBy('timestamp')
          .onSnapshot(snapshot => {
            const mensajes = snapshot.docs.map(doc => doc.data());
            renderChat(chatPsico, mensajes, 'psicologo');
          });
      }
      auth.onAuthStateChanged(user => {
        if(user){
          const docRef = db.collection('usuarios').doc(user.uid);
          docRef.get().then(docSnap => {
            if(docSnap.exists && docSnap.data().rol === 'psicologo'){
              listenChatPsico(user.uid);
              if(btnSendPsico && msgPsico){
                btnSendPsico.onclick = () => {
                  const text = msgPsico.value.trim();
                  if(!text) return;
                  db.collection('conversaciones').doc(user.uid + '_coordinador').collection('mensajes').add({
                    text,
                    userType: 'psicologo',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
                  msgPsico.value = '';
                };
              }
            }
          });
        }
      });

      // --- Navegación entre vistas ---
      document.getElementById('btnPsicologo').addEventListener('click', function() {
        document.getElementById('acceso').classList.add('hidden');
        document.getElementById('vistaPsicologo').classList.remove('hidden');
        document.getElementById('vistaCoordinador').classList.add('hidden');
      });
      document.getElementById('btnCoordinador').addEventListener('click', function() {
        document.getElementById('acceso').classList.add('hidden');
        document.getElementById('vistaPsicologo').classList.add('hidden');
        document.getElementById('vistaCoordinador').classList.remove('hidden');
      });
      document.getElementById('btnSalirPsicologo').addEventListener('click', function() {
        document.getElementById('acceso').classList.remove('hidden');
        document.getElementById('vistaPsicologo').classList.add('hidden');
        document.getElementById('vistaCoordinador').classList.add('hidden');
      });
      document.getElementById('btnSalirCoordinador').addEventListener('click', function() {
        document.getElementById('acceso').classList.remove('hidden');
        document.getElementById('vistaPsicologo').classList.add('hidden');
        document.getElementById('vistaCoordinador').classList.add('hidden');
      });

      // --- Autocompletado y funcionalidad principal ---
      var zonasDisponibles = [
        "Ávila Zona Sur - Arenas de San Pedro",
        "Ávila Zona Norte - Ávila/Arévalo",
        "Burgos Zona Norte - Miranda de Ebro",
        "Burgos Zona Centro - Burgos",
        "Burgos Zona Sureste - Aranda de Duero",
        "León Zona Suroeste - La Bañeza",
        "León Zona Nordeste - León",
        "León Zona Astorga",
        "León Zona Noroeste - Bierzo",
        "Palencia Zona Norte - Herrera de Pisuerga",
        "Palencia Zona Sur - Palencia",
        "Salamanca Zona Suroeste - Ciudad Rodrigo",
        "Salamanca Zona Sureste - Béjar",
        "Salamanca Zona Norte - Salamanca",
        "Segovia Zona Sur - Segovia",
        "Segovia Zona Norte - Cuéllar",
        "Soria Zona Este - Soria",
        "Soria Zona Oeste - Burgo de Osma",
        "Valladolid Zona Norte - Valladolid/Rioseco",
        "Valladolid Zona Sur - Medina/Olmedo",
        "Valladolid Zona Este - Peñafiel",
        "Zamora Zona Nordeste - Benavente",
        "Zamora Zona Noroeste - Puebla de Sanabria",
        "Zamora Zona Sur - Zamora"
      ];
      var zonaInput = document.getElementById('zona');
      var zonaSugerencias = document.getElementById('zona-sugerencias');
      if(zonaInput){
        zonaInput.addEventListener('input', function() {
          const valor = zonaInput.value.toLowerCase();
          zonaSugerencias.innerHTML = '';
          if (!valor) {
            zonaSugerencias.style.display = 'none';
            return;
          }
          const sugerencias = zonasDisponibles.filter(z => z.toLowerCase().includes(valor));
          if (sugerencias.length === 0) {
            zonaSugerencias.style.display = 'none';
            return;
          }
          sugerencias.forEach(zona => {
            const div = document.createElement('div');
            div.textContent = zona;
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.addEventListener('mousedown', function(e) {
              zonaInput.value = zona;
              zonaSugerencias.style.display = 'none';
            });
            zonaSugerencias.appendChild(div);
          });
          zonaSugerencias.style.display = 'block';
        });
        zonaInput.addEventListener('blur', function() {
          setTimeout(() => zonaSugerencias.style.display = 'none', 100);
        });
      }
      var filtroZonaInput = document.getElementById('filtroZona');
      var filtroZonaSugerencias = document.getElementById('filtroZona-sugerencias');
      if(filtroZonaInput){
        filtroZonaInput.addEventListener('input', function() {
          const valor = filtroZonaInput.value.toLowerCase();
          filtroZonaSugerencias.innerHTML = '';
          if (!valor) {
            filtroZonaSugerencias.style.display = 'none';
            return;
          }
          const sugerencias = zonasDisponibles.filter(z => z.toLowerCase().includes(valor));
          if (sugerencias.length === 0) {
            filtroZonaSugerencias.style.display = 'none';
            return;
          }
          sugerencias.forEach(zona => {
            const div = document.createElement('div');
            div.textContent = zona;
            div.style.padding = '8px';
            div.style.cursor = 'pointer';
            div.addEventListener('mousedown', function(e) {
              filtroZonaInput.value = zona;
              filtroZonaSugerencias.style.display = 'none';
              mostrarListadoFirestoreFirestore({ dia: filtroDia.value, zona: zona, turno: filtroTurno.value });
            });
            filtroZonaSugerencias.appendChild(div);
          });
          filtroZonaSugerencias.style.display = 'block';
        });
        filtroZonaInput.addEventListener('blur', function() {
          setTimeout(() => filtroZonaSugerencias.style.display = 'none', 100);
        });
      }
      var jsPDF = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : null;
      var STORAGE_KEY = 'psicologos_por_semana_zona_turno_v2';
      var form = document.getElementById('formPsico');
      var listaCont = document.getElementById('listadoContainer');
      var filtroDia = document.getElementById('filtroDia');
      var filtroTurno = document.getElementById('filtroTurno');
      var btnDescargarPDF = document.getElementById('btnDescargarPDF');
      var btnBorrarTodo = document.getElementById('btnBorrarTodo');
      function cargar() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch (e) {
          document.getElementById('loginError').textContent = 'Error al cargar los datos.';
          return [];
        }
      }
      function guardar(datos) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
        } catch (e) {
          alert('Error al guardar los datos. Puede que el almacenamiento esté lleno.');
        }
      }
      function rangoSemana(weekStr) {
        const [year, week] = weekStr.split('-W').map(Number);
        const primerDia = new Date(year, 0, 1);
        const diaSemana = primerDia.getDay();
        const primerLunes = new Date(primerDia);
        let diff = 1 - diaSemana;
        if (diff > 0) diff -= 7;
        primerLunes.setDate(primerDia.getDate() + diff);
        const inicioSemana = new Date(primerLunes);
        inicioSemana.setDate(primerLunes.getDate() + (week - 1) * 7);
        const finSemana = new Date(inicioSemana);
        finSemana.setDate(inicioSemana.getDate() + 6);
        return { inicioSemana, finSemana };
      }
      async function mostrarListadoFirestoreFirestore({ dia = '', zona = '', turno = '' } = {}) {
        if(!listaCont) return;
        let snapshot = await db.collection('disponibilidad').get();
        let datos = snapshot.docs.map(doc => doc.data());
        if (dia) {
          const filtroFecha = new Date(dia);
          datos = datos.filter(r => {
            const [year, week] = r.semana.split('-W').map(Number);
            const primerDia = new Date(year, 0, 1);
            const diaSemana = primerDia.getDay();
            const primerLunes = new Date(primerDia);
            let diff = 1 - diaSemana;
            if (diff > 0) diff -= 7;
            primerLunes.setDate(primerDia.getDate() + diff);
            const inicioSemana = new Date(primerLunes);
            inicioSemana.setDate(primerLunes.getDate() + (week - 1) * 7);
            const finSemana = new Date(inicioSemana);
            finSemana.setDate(inicioSemana.getDate() + 6);
            return filtroFecha >= inicioSemana && filtroFecha <= finSemana;
          });
        }
        if (zona) {
          datos = datos.filter(r => r.zona === zona);
        }
        if (turno) {
          datos = datos.filter(r => r.turno === turno);
        }
        listaCont.innerHTML = '';
        if (!datos.length) {
          listaCont.innerHTML = '<div class=\"empty\">No hay registros.</div>';
          return;
        }
        const grupos = {};
        datos.forEach(r => {
          grupos[r.semana] = grupos[r.semana] || [];
          grupos[r.semana].push(r);
        });
        Object.keys(grupos).sort().forEach(sem => {
          const header = document.createElement('div');
          header.style.fontWeight = '700';
          header.style.marginTop = '10px';
          header.textContent = `Semana ${sem}`;
          listaCont.appendChild(header);
          const ul = document.createElement('ul');
          grupos[sem].forEach((r, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div>
                <strong>${r.nombre}</strong> — ${r.zona} — <em>${r.telefono}</em>
                <div class=\"meta\">Turno: ${r.turno}${r.notas ? ' · ' + r.notas : ''}</div>
              </div>
            `;
            ul.appendChild(li);
          });
          listaCont.appendChild(ul);
        });
      }
      function mostrarListadoFirestore({ dia = '', zona = '', turno = '' } = {}) {
        if(!listaCont) return;
        db.collection('disponibilidad').get().then(snapshot => {
          let datos = snapshot.docs.map(doc => ({...doc.data(), id: doc.id}));
          if (dia) {
            const filtroFecha = new Date(dia);
            datos = datos.filter(r => {
              const { inicioSemana, finSemana } = rangoSemana(r.semana);
              return filtroFecha >= inicioSemana && filtroFecha <= finSemana;
            });
          }
          if (zona) {
            datos = datos.filter(r => r.zona === zona);
          }
          if (turno) {
            datos = datos.filter(r => r.turno === turno);
          }
          listaCont.innerHTML = '';
          if (!datos.length) {
            listaCont.innerHTML = '<div class=\"empty\">No hay registros.</div>';
            return;
          }
          const grupos = {};
          datos.forEach(r => {
            grupos[r.semana] = grupos[r.semana] || [];
            grupos[r.semana].push(r);
          });
          Object.keys(grupos).sort().forEach(sem => {
            const { inicioSemana, finSemana } = rangoSemana(sem);
            const header = document.createElement('div');
            header.style.fontWeight = '700';
            header.style.marginTop = '10px';
            header.textContent = `Semana ${sem} (${inicioSemana.toLocaleDateString()} - ${finSemana.toLocaleDateString()})`;
            listaCont.appendChild(header);
            const ul = document.createElement('ul');
            grupos[sem].forEach((r, index) => {
              const li = document.createElement('li');
              li.innerHTML = `
                <div>
                  <strong>${r.nombre}</strong> — ${r.zona} — <em>${r.telefono}</em>
                  <div class=\"meta\">Turno: ${r.turno}${r.notas ? ' · ' + r.notas : ''}</div>
                </div>
              `;
              const btnEliminar = document.createElement('button');
              btnEliminar.textContent = 'Eliminar';
              btnEliminar.className = 'btn-eliminar';
              btnEliminar.onclick = () => {
                eliminarRegistroFirestore(r.id);
              };
              li.appendChild(btnEliminar);
              ul.appendChild(li);
            });
            listaCont.appendChild(ul);
          });
        });
      }
      function eliminarRegistroFirestore(id) {
        db.collection('disponibilidad').doc(id).delete().then(() => {
          mostrarListadoFirestoreFirestore({ dia: filtroDia.value, zona: filtroZonaInput.value, turno: filtroTurno.value });
          mostrarListadoFirestore({ dia: filtroDia.value, zona: filtroZonaInput.value, turno: filtroTurno.value });
        });
      }
      if(btnBorrarTodo){
        btnBorrarTodo.addEventListener('click', () => {
          db.collection('disponibilidad').get().then(snapshot => {
            const batch = db.batch();
            snapshot.forEach(doc => batch.delete(doc.ref));
            batch.commit().then(() => {
              mostrarListadoFirestoreFirestore({});
              mostrarListadoFirestore({});
            });
          });
        });
      }
      if(form){
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const registro = {
            nombre: form.nombre.value.trim(),
            telefono: form.telefono.value.trim(),
            zona: form.zona.value,
            semana: form.semana.value,
            turno: form.turno.value,
            notas: form.notas.value.trim(),
            userId: auth.currentUser.uid
          };
          if (!registro.nombre || !registro.telefono || !registro.zona || !registro.semana || !registro.turno) {
            alert('Completa todos los campos obligatorios');
            return;
          }
          try {
            await db.collection('disponibilidad').add(registro);
            form.reset();
            mostrarListadoFirestoreFirestore();
          } catch (e) {
            alert('Error al guardar: ' + e.message);
          }
        });
        if(filtroDia){
          filtroDia.addEventListener('change', () => {
            mostrarListadoFirestore({ dia: filtroDia.value, zona: filtroZonaInput.value, turno: filtroTurno.value });
          });
        }
        if(filtroZonaInput){
          filtroZonaInput.addEventListener('change', () => {
            mostrarListadoFirestore({ dia: filtroDia.value, zona: filtroZonaInput.value, turno: filtroTurno.value });
          });
        }
        if(filtroTurno){
          filtroTurno.addEventListener('change', () => {
            mostrarListadoFirestore({ dia: filtroDia.value, zona: filtroZonaInput.value, turno: filtroTurno.value });
          });
        }
        if(document.getElementById('btnVerTodos')){
          document.getElementById('btnVerTodos').addEventListener('click', () => {
            filtroDia.value = '';
            filtroZonaInput.value = '';
            filtroTurno.value = '';
            mostrarListadoFirestoreFirestore({});
          });
        }
        if(btnDescargarPDF){
          btnDescargarPDF.addEventListener('click', () => {
            db.collection('disponibilidad').get().then(snapshot => {
              let datos = snapshot.docs.map(doc => doc.data());
              let datosFiltrados = datos;
              if (filtroDia.value) {
                const filtroFecha = new Date(filtroDia.value);
                datosFiltrados = datosFiltrados.filter(r => {
                  const { inicioSemana, finSemana } = rangoSemana(r.semana);
                  return filtroFecha >= inicioSemana && filtroFecha <= finSemana;
                });
              }
              if (filtroZonaInput.value) {
                datosFiltrados = datosFiltrados.filter(r => r.zona === filtroZonaInput.value);
              }
              if (filtroTurno.value) {
                datosFiltrados = datosFiltrados.filter(r => r.turno === filtroTurno.value);
              }
              if (!datosFiltrados.length) {
                alert('No hay datos para descargar con los filtros actuales.');
                return;
              }
              const doc = new jsPDF();
              doc.setFontSize(14);
              doc.text('Listado Psicólogos de Emergencia', 14, 20);
              let y = 30;
              const grupos = {};
              datosFiltrados.forEach(r => {
                grupos[r.semana] = grupos[r.semana] || [];
                grupos[r.semana].push(r);
              });
              Object.keys(grupos).sort().forEach(sem => {
                const { inicioSemana, finSemana } = rangoSemana(sem);
                doc.setFontSize(12);
                doc.text(`Semana ${sem} (${inicioSemana.toLocaleDateString()} - ${finSemana.toLocaleDateString()})`, 14, y);
                y += 8;
                doc.setFontSize(10);
                grupos[sem].forEach(r => {
                  const texto = `${r.nombre} | ${r.zona} | ${r.telefono} | Turno: ${r.turno}${r.notas ? ' | ' + r.notas : ''}`;
                  const splitTexto = doc.splitTextToSize(texto, 180);
                  doc.text(splitTexto, 14, y);
                  y += splitTexto.length * 7;
                  if (y > 270) {
                    doc.addPage();
                    y = 20;
                  }
                });
                y += 6;
              });
              doc.save('listado_psicologos.pdf');
            });
          });
          mostrarListadoFirestoreFirestore({});
        }
      }
    </script>
